{"version":3,"sources":["../app/ec-encrypt.js"],"names":[],"mappings":";;;;;;AAAA;;;;AACA;;;;;;AAIA,IAAM,SAAS,EAAT;;AAEN,SAAS,cAAT,CAAyB,EAAzB,EAA6B,GAA7B,EAAkC,UAAlC,EAA8C;AAC5C,MAAI,cAAc,GAAG,MAAH,GAAY,IAAI,MAAJ,GAAa,WAAW,MAAX,CADC;AAE5C,MAAI,MAAM,OAAO,MAAP,CAAc,CAAC,EAAD,EAAK,UAAL,EAAiB,GAAjB,CAAd,EAAqC,WAArC,CAAN,CAFwC;;AAI5C,MAAI,QAAQ,IAAI,QAAJ,CAAa,QAAb,CAAR,CAJwC;AAK5C,UAAQ,MAAM,OAAN,CAAc,KAAd,EAAqB,IAArB,CAAR,CAL4C;AAM5C,UAAQ,MAAM,OAAN,CAAc,KAAd,EAAqB,IAArB,CAAR,CAN4C;;AAQ5C,SAAO,KAAP,CAR4C;CAA9C;;AAWA,SAAS,SAAT,CAAoB,IAApB,EAA0B,GAA1B,EAA+B,MAA/B,EAAuC;AACrC,MAAM,SAAS,iBAAO,cAAP,CAAsB,aAAtB,EAAqC,IAArC,EAA2C,GAA3C,CAAT,CAD+B;AAErC,MAAI,YAAY,OAAO,MAAP,CAAc,MAAd,CAAZ,CAFiC;AAGrC,MAAI,QAAQ,OAAO,KAAP,EAAR,CAHiC;AAIrC,MAAI,cAAc,UAAU,MAAV,GAAmB,MAAM,MAAN,CAJA;;AAMrC,cAAY,OAAO,MAAP,CAAc,CAAC,SAAD,EAAY,KAAZ,CAAd,EAAkC,WAAlC,CAAZ,CANqC;;AAQrC,SAAO;AACL,gBAAY,SAAZ;AACA,SAAK,OAAO,UAAP,EAAL;GAFF,CARqC;CAAvC;;AAcA,SAAS,UAAT,GAAuB;AACrB,SAAO,iBAAO,WAAP,CAAmB,MAAnB,CAAP,CADqB;CAAvB;;AAIA,SAAS,YAAT,CAAuB,GAAvB,EAA4B;AAC1B,SAAO,iBAAO,UAAP,CAAkB,QAAlB,EACJ,MADI,CACG,GADH,EACQ,MADR,EAEJ,MAFI,EAAP,CAD0B;CAA5B;;AAMA,SAAS,aAAT,CAAwB,MAAxB,EAAgC,GAAhC,EAAqC;AACnC,MAAM,OAAO,KAAK,YAAL,CAAkB,GAAlB,CAAP,CAD6B;AAEnC,MAAM,KAAK,KAAK,UAAL,EAAL,CAF6B;AAGnC,MAAM,SAAS,KAAK,SAAL,CAAe,IAAf,EAAqB,EAArB,EAAyB,IAAI,MAAJ,CAAW,MAAX,CAAzB,CAAT,CAH6B;AAInC,MAAM,QAAQ,KAAK,cAAL,CAAoB,EAApB,EAAwB,OAAO,GAAP,EAAY,OAAO,UAAP,CAA5C,CAJ6B;;AAMnC,SAAO,KAAP,CANmC;CAArC;;AASA,SAAS,IAAT,CAAe,IAAf,EAAqB;AACnB,MAAI,MAAM,KAAK,CAAL,CAAN,CADe;AAEnB,MAAI,SAAS,KAAK,CAAL,CAAT,CAFe;;AAInB,MAAI,QAAQ,KAAK,aAAL,CAAmB,MAAnB,EAA2B,GAA3B,CAAR,CAJe;AAKnB,UAAQ,GAAR,CAAY,KAAZ,EALmB;CAArB;;kBAQe;AACb,gCADa;AAEb,sBAFa;AAGb,wBAHa;AAIb,4BAJa;AAKb,8BALa;AAMb,YANa","file":"ec-encrypt.js","sourcesContent":["import crypto from 'crypto';\nimport 'source-map-support/register';\n\n/* Edgecast token generation ported from ectoken_v3 */\n\nconst IV_LEN = 12;\n\nfunction constructToken (iv, tag, ciphertext) {\n  let totalLength = iv.length + tag.length + ciphertext.length;\n  let buf = Buffer.concat([iv, ciphertext, tag], totalLength);\n\n  let token = buf.toString('base64');\n  token = token.replace(/\\+/g, '\\-');\n  token = token.replace(/\\//g, '\\_');\n\n  return token;\n}\n\nfunction ecEncrypt (aKey, aIv, string) {\n  const cipher = crypto.createCipheriv('aes-256-gcm', aKey, aIv);\n  let encrypted = cipher.update(string);\n  let final = cipher.final();\n  let totalLength = encrypted.length + final.length;\n\n  encrypted = Buffer.concat([encrypted, final], totalLength);\n\n  return {\n    ciphertext: encrypted,\n    tag: cipher.getAuthTag()\n  };\n}\n\nfunction generateIv () {\n  return crypto.randomBytes(IV_LEN);\n}\n\nfunction generateHash (key) {\n  return crypto.createHash('sha256')\n    .update(key, 'utf8')\n    .digest();\n}\n\nfunction generateToken (string, key) {\n  const hash = this.generateHash(key);\n  const iv = this.generateIv();\n  const cipher = this.ecEncrypt(hash, iv, new Buffer(string));\n  const token = this.constructToken(iv, cipher.tag, cipher.ciphertext);\n\n  return token;\n}\n\nfunction main (argv) {\n  let key = argv[2];\n  let string = argv[3];\n\n  let token = this.generateToken(string, key);\n  console.log(token);\n}\n\nexport default {\n  constructToken,\n  ecEncrypt,\n  generateIv,\n  generateHash,\n  generateToken,\n  main\n}\n"]}